# üö™ APB System - Anti-Passback –¥–ª—è Hikvision

![Python](https://img.shields.io/badge/python-3.8+-blue.svg)
![Flask](https://img.shields.io/badge/flask-3.0-green.svg)
![MySQL](https://img.shields.io/badge/mysql-8.0+-orange.svg)

–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π Anti-Passback –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ Hikvision. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ, –ø–æ–∫–∞ –Ω–µ –≤—ã–π–¥–µ—Ç.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **18 —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤** - 9 –≤—Ö–æ–¥–∞ + 9 –≤—ã—Ö–æ–¥–∞
- ‚úÖ **APB –ª–æ–≥–∏–∫–∞** - –∑–∞–ø—Ä–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –±–µ–∑ –≤—ã—Ö–æ–¥–∞
- ‚úÖ **MySQL** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç
- ‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–µ—Ä—è–º–∏** - —á–µ—Ä–µ–∑ HCNetSDK
- ‚úÖ **Graceful degradation** - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —á–∞—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –æ—Ñ–ª–∞–π–Ω
- ‚úÖ **–ê–≤—Ç–æ—Å–±—Ä–æ—Å** - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –≤—Ä–µ–º—è
- ‚úÖ **REST API** - —Å—Ç–∞—Ç—É—Å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HTTP
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–æ–Ω—Å–æ–ª—å + —Ñ–∞–π–ª—ã + –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

## üìã –ü—Ä–∞–≤–∏–ª–∞ Anti-Passback

| –°–æ—Å—Ç–æ—è–Ω–∏–µ | –¢–µ—Ä–º–∏–Ω–∞–ª | –î–µ–π—Å—Ç–≤–∏–µ | –î–≤–µ—Ä—å |
|-----------|----------|----------|-------|
| outside | entry (–≤—Ö–æ–¥) | ‚úÖ –†–ê–ó–†–ï–®–ï–ù–û | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è |
| outside | exit (–≤—ã—Ö–æ–¥) | ‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï | –ó–∞–∫—Ä—ã—Ç–∞ |
| inside | entry (–≤—Ö–æ–¥) | ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û | –ó–∞–∫—Ä—ã—Ç–∞ |
| inside | exit (–≤—ã—Ö–æ–¥) | ‚úÖ –†–ê–ó–†–ï–®–ï–ù–û | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è |

### ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞

–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–æ–∫–∞–∑–∞–ª –ª–∏—Ü–æ/–∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≤—Ö–æ–¥–∞, –Ω–æ –Ω–µ —É—Å–ø–µ–ª –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç, –æ–Ω –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –≤—Ö–æ–¥–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ **1 –º–∏–Ω—É—Ç—ã** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ENTRY_WINDOW_SECONDS`).

**–ü—Ä–∏–º–µ—Ä:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞–∑–∞–ª –ª–∏—Ü–æ –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≤—Ö–æ–¥–∞ ‚Üí –≤—Ö–æ–¥ —Ä–∞–∑—Ä–µ—à–µ–Ω, –¥–≤–µ—Ä—å –æ—Ç–∫—Ä—ã–ª–∞—Å—å
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—Å–ø–µ–ª –ø—Ä–æ–π—Ç–∏ (–æ—Ç–≤–ª–µ–∫—Å—è, –¥–≤–µ—Ä—å –∑–∞–∫—Ä—ã–ª–∞—Å—å –∏ —Ç.–¥.)
3. –í —Ç–µ—á–µ–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ü–æ ‚Üí –≤—Ö–æ–¥ –±—É–¥–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ
4. –ü–æ—Å–ª–µ 60 —Å–µ–∫—É–Ω–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –±—É–¥–µ—Ç –∑–∞–ø—Ä–µ—â–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–Ω—É—Ç—Ä–∏)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SDK Hikvision

SDK –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. –°–∫–∞—á–∞–π—Ç–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:

```bash
# –°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ SDK_INSTALL.md
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MySQL

```bash
mysql -u root -p < setup_database.sql
```

### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è .env

```bash
cp .env.example .env
nano .env  # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ:**

- `DB_HOST`, `DB_USER`, `DB_PASSWORD` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL
- `TERMINAL_IN_*` –∏ `TERMINAL_OUT_*` - IP –∞–¥—Ä–µ—Å–∞ –≤–∞—à–∏—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
- `TERMINAL_USER`, `TERMINAL_PASSWORD` - —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤

### 5. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)

–ï—Å–ª–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `event_logs`, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π `status_code` –∏ `is_violation`:

**–í–∞—Ä–∏–∞–Ω—Ç 1: Python —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```bash
python migrate_status_codes.py
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: SQL —Å–∫—Ä–∏–ø—Ç**

```bash
mysql -u root -p apb_system < migrate_status_codes.sql
```

‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ü–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π —Å–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!

### 6. –ó–∞–ø—É—Å–∫

```bash
python main.py
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ Hikvision

–ù–∞ **–∫–∞–∂–¥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ** (221-238) –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:

1. **Configuration** ‚Üí **Network** ‚Üí **Advanced Settings** ‚Üí **HTTP Listening**
2. –í–∫–ª—é—á–∏—Ç–µ **HTTP Listening**
3. URL: `http://YOUR_SERVER_IP:3000/event`
4. Protocol Version: **1.0**
5. –û—Ç–º–µ—Ç—å—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ **Face Recognition Success**
   - ‚úÖ **Card Swiped**
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üì° API Endpoints

### `GET /`

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã

```bash
curl http://localhost:3000/
```

### `GET /status`

–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```bash
curl http://localhost:3000/status
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –≤–Ω—É—Ç—Ä–∏ –∑–¥–∞–Ω–∏—è.

### `POST /reset`

–†—É—á–Ω–æ–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π (admin)

```bash
curl -X POST http://localhost:3000/reset
```

### `GET /violations`

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è APB

```bash
# –í—Å–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
curl http://localhost:3000/violations

# –ù–∞—Ä—É—à–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥
curl "http://localhost:3000/violations?start_date=2024-01-01&end_date=2024-01-31"

# –ù–∞—Ä—É—à–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl "http://localhost:3000/violations?user_name=–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
```

### `GET /violations/stats`

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π APB

```bash
curl http://localhost:3000/violations/stats
```

### `GET /violations/<status_code>`

–ù–∞—Ä—É—à–µ–Ω–∏—è –ø–æ –∫–æ–¥—É —Å—Ç–∞—Ç—É—Å–∞

```bash
# –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ –∫–æ–≥–¥–∞ —É–∂–µ –≤–Ω—É—Ç—Ä–∏
curl http://localhost:3000/violations/DENIED_ALREADY_INSIDE
```

### `POST /event`

–ü—Ä–∏–µ–º —Å–æ–±—ã—Ç–∏–π –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã

**user_states** - —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```sql
SELECT * FROM user_states WHERE state='inside';
```

**event_logs** - –∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π

```sql
SELECT * FROM event_logs ORDER BY created_at DESC LIMIT 20;
```

**–ù–∞—Ä—É—à–µ–Ω–∏—è APB** - –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ –∫–æ–≥–¥–∞ —É–∂–µ –≤–Ω—É—Ç—Ä–∏

```sql
-- –í—Å–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
SELECT * FROM event_logs WHERE is_violation = TRUE ORDER BY created_at DESC;

-- –ù–∞—Ä—É—à–µ–Ω–∏—è –ø–æ –∫–æ–¥—É —Å—Ç–∞—Ç—É—Å–∞
SELECT * FROM event_logs WHERE status_code = 'DENIED_ALREADY_INSIDE';

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
SELECT user_name, COUNT(*) as violations_count
FROM event_logs
WHERE is_violation = TRUE
GROUP BY user_name
ORDER BY violations_count DESC;
```

**–ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–±—ã—Ç–∏–π:**

- `SUCCESS_ENTRY` - —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
- `SUCCESS_EXIT` - —É—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥
- `ALLOWED_TIME_WINDOW` - —Ä–∞–∑—Ä–µ—à–µ–Ω –≤—Ö–æ–¥ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
- `DENIED_ALREADY_INSIDE` - –∑–∞–ø—Ä–µ—â–µ–Ω –≤—Ö–æ–¥, —É–∂–µ –≤–Ω—É—Ç—Ä–∏ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ APB)
- `DENIED_OUTSIDE_WINDOW` - –∑–∞–ø—Ä–µ—â–µ–Ω –≤—Ö–æ–¥, –≤–Ω–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ APB)
- `WARNING_EXIT_WITHOUT_ENTRY` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –±–µ–∑ –≤—Ö–æ–¥–∞

**–ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - —Å–º. —Ñ–∞–π–ª `queries.sql`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã

```bash
python check_system.py
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤

```bash
python test_system.py
```

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
apb/
‚îú‚îÄ‚îÄ main.py                    # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ db.py                      # –ú–æ–¥—É–ª—å —Ä–∞–±–æ—Ç—ã —Å MySQL
‚îú‚îÄ‚îÄ requirements.txt           # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–æ–∑–¥–∞—Ç—å!)
‚îú‚îÄ‚îÄ .env.example               # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ setup_database.sql         # –°–æ–∑–¥–∞–Ω–∏–µ –ë–î
‚îú‚îÄ‚îÄ migrate_status_codes.py    # –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (Python)
‚îú‚îÄ‚îÄ migrate_status_codes.sql  # –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (SQL)
‚îú‚îÄ‚îÄ check_system.py            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ test_system.py             # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ HCNetSDK.dll           # SDK Hikvision
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `event_logs`, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π `status_code` –∏ `is_violation`.

### ‚ö†Ô∏è –ü–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**

```bash
mysqldump -u root -p apb_system > backup_$(date +%Y%m%d_%H%M%S).sql
```

### –í–∞—Ä–∏–∞–Ω—Ç 1: Python —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
python migrate_status_codes.py
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- –î–æ–±–∞–≤–∏—Ç –ø–æ–ª—è `status_code` –∏ `is_violation` –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
- –ó–∞–ø–æ–ª–Ω–∏—Ç –∏—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (`action_taken`, `terminal_type`, `state_before`, `state_after`)
- –ü–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–∏–≥—Ä–∞—Ü–∏–∏
- –ë–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### –í–∞—Ä–∏–∞–Ω—Ç 2: SQL —Å–∫—Ä–∏–ø—Ç

```bash
mysql -u root -p apb_system < migrate_status_codes.sql
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

–ú–∏–≥—Ä–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `status_code` –∏ `is_violation` –Ω–∞ –æ—Å–Ω–æ–≤–µ:

- `action_taken` - —Ç–µ–∫—Å—Ç –¥–µ–π—Å—Ç–≤–∏—è
- `terminal_type` - —Ç–∏–ø —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (entry/exit)
- `state_before` –∏ `state_after` - —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ –∏ –ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏—è

**–ü—Ä–∏–º–µ—Ä—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:**

- `"–í–•–û–î –†–ê–ó–†–ï–®–ï–ù"` + `entry` + `outside‚Üíinside` ‚Üí `SUCCESS_ENTRY`
- `"–í–•–û–î –ó–ê–ü–†–ï–©–ï–ù - —É–∂–µ –≤–Ω—É—Ç—Ä–∏"` + `entry` ‚Üí `DENIED_ALREADY_INSIDE` (–Ω–∞—Ä—É—à–µ–Ω–∏–µ)
- `"–í–´–•–û–î –†–ê–ó–†–ï–®–ï–ù"` + `exit` + `inside‚Üíoutside` ‚Üí `SUCCESS_EXIT`

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

```env
# –¢–µ—Ä–º–∏–Ω–∞–ª—ã –≤—Ö–æ–¥–∞ (–Ω–µ—á–µ—Ç–Ω—ã–µ IP)
TERMINAL_IN_1=192.168.18.221
TERMINAL_IN_2=192.168.18.223
TERMINAL_IN_3=192.168.18.225
TERMINAL_IN_4=192.168.18.227
TERMINAL_IN_5=192.168.18.229

TERMINAL_IN_6=192.168.18.231
TERMINAL_IN_7=192.168.18.233
TERMINAL_IN_8=192.168.18.235
TERMINAL_IN_9=192.168.18.237

# –¢–µ—Ä–º–∏–Ω–∞–ª—ã –≤—ã—Ö–æ–¥–∞ (—á–µ—Ç–Ω—ã–µ IP)
TERMINAL_OUT_1=192.168.18.222
TERMINAL_OUT_2=192.168.18.224
TERMINAL_OUT_3=192.168.18.226
TERMINAL_OUT_4=192.168.18.228
TERMINAL_OUT_5=192.168.18.230

TERMINAL_OUT_6=192.168.18.232
TERMINAL_OUT_7=192.168.18.234
TERMINAL_OUT_8=192.168.18.236
TERMINAL_OUT_9=192.168.18.238

# –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
TERMINAL_PORT=8000
TERMINAL_USER=admin
TERMINAL_PASSWORD=123456

# MySQL
DB_HOST=localhost
DB_NAME=apb_system
DB_USER=root
DB_PASSWORD=your_password

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ APB
RESET_TIME=00:00         # –í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ (HH:MM)
DOOR_OPEN_TIME=3         # –°–µ–∫—É–Ω–¥—ã –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–≤–µ—Ä–∏
ENTRY_WINDOW_SECONDS=60  # –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Å–µ–∫—É–Ω–¥—ã)
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:

```
============================================================
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
üìç –¢–µ—Ä–º–∏–Ω–∞–ª: 192.168.18.221 (entry)
üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: outside
============================================================
‚úÖ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ –≤—Ö–æ–¥–∏—Ç –≤ –∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 192.168.18.221
‚úèÔ∏è  –î–µ–π—Å—Ç–≤–∏–µ: –í–•–û–î –†–ê–ó–†–ï–®–ï–ù
üîÑ –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: inside
============================================================
```

### –õ–æ–≥–∏ —Ñ–∞–π–ª—ã

–î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤ –ø–∞–ø–∫–µ `logs/`:

```
logs/YYYYMMDD_HHMMSS_MMMMMM/
  ‚îú‚îÄ‚îÄ headers.json
  ‚îú‚îÄ‚îÄ AccessControllerEvent.json
  ‚îî‚îÄ‚îÄ photo.jpg
```

### –õ–æ–≥–∏ –≤ MySQL

```sql
-- –°–æ–±—ã—Ç–∏—è —Å–µ–≥–æ–¥–Ω—è
SELECT * FROM event_logs WHERE DATE(created_at) = CURDATE();

-- –ù–∞—Ä—É—à–µ–Ω–∏—è APB (–Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–± —Å –∫–æ–¥–∞–º–∏ —Å—Ç–∞—Ç—É—Å–æ–≤)
SELECT * FROM event_logs WHERE is_violation = TRUE ORDER BY created_at DESC;

-- –ù–∞—Ä—É—à–µ–Ω–∏—è APB –ø–æ –∫–æ–¥—É —Å—Ç–∞—Ç—É—Å–∞
SELECT * FROM event_logs WHERE status_code = 'DENIED_ALREADY_INSIDE';

-- –¢–æ–ø –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π
SELECT user_name, COUNT(*) as violations
FROM event_logs
WHERE is_violation = TRUE
GROUP BY user_name
ORDER BY violations DESC
LIMIT 10;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–Ω—É—Ç—Ä–∏
SELECT * FROM user_states WHERE state='inside';
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `.env` (–Ω–µ –≤ git!)
- ‚úÖ `.gitignore` –∑–∞—â–∏—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
- ‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è

## üö® Troubleshooting

### "Login failed" –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
ping 192.168.18.221

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ .env
```

### "MySQL connection error"

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ MySQL
net start MySQL80          # Windows
systemctl start mysql      # Linux

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å –≤ .env
```

### "HCNetSDK.dll not found"

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ DLL –≤ –ø–∞–ø–∫–µ lib/
ls lib/HCNetSDK.dll
```

### –¢–µ—Ä–º–∏–Ω–∞–ª –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HTTP Listening –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ—Ä—Ç 3000 –¥–æ—Å—Ç—É–ø–µ–Ω

### –¢–µ—Ä–º–∏–Ω–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É!**

- –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã
- APB –ª–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–µ—Ä—è–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
- –°–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª –æ—Ñ–ª–∞–π–Ω

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Python 3.8+**
- **Flask 3.0** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **MySQL 8.0+** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **mysql-connector-python** - –¥—Ä–∞–π–≤–µ—Ä –ë–î
- **HCNetSDK.dll** - SDK Hikvision

## üìù –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8 –∏–ª–∏ –≤—ã—à–µ
- MySQL 8.0 –∏–ª–∏ –≤—ã—à–µ
- Windows 10/11 –∏–ª–∏ Linux
- HCNetSDK.dll –æ—Ç Hikvision
- –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫

### Windows (Task Scheduler)

–°–æ–∑–¥–∞–π—Ç–µ bat —Ñ–∞–π–ª –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á.

### Linux (systemd)

```bash
sudo nano /etc/systemd/system/apb.service
```

–°–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `python check_system.py`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `logs/` –∏ —Ç–∞–±–ª–∏—Ü—É `event_logs`
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

akmalovichdev - –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã ¬© 2024

---

**–í–µ—Ä—Å–∏—è:** 1.0.0
**–î–∞—Ç–∞:** –û–∫—Ç—è–±—Ä—å 2024
