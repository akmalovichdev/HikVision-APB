# üö™ APB System - Anti-Passback –¥–ª—è Hikvision

![Python](https://img.shields.io/badge/python-3.8+-blue.svg)
![Flask](https://img.shields.io/badge/flask-3.0-green.svg)
![MySQL](https://img.shields.io/badge/mysql-8.0+-orange.svg)

–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π Anti-Passback –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ Hikvision. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ, –ø–æ–∫–∞ –Ω–µ –≤—ã–π–¥–µ—Ç.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **10 —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤** - 5 –≤—Ö–æ–¥–∞ + 5 –≤—ã—Ö–æ–¥–∞
- ‚úÖ **APB –ª–æ–≥–∏–∫–∞** - –∑–∞–ø—Ä–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –±–µ–∑ –≤—ã—Ö–æ–¥–∞
- ‚úÖ **MySQL** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç
- ‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–µ—Ä—è–º–∏** - —á–µ—Ä–µ–∑ HCNetSDK
- ‚úÖ **–ê–≤—Ç–æ—Å–±—Ä–æ—Å** - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –≤—Ä–µ–º—è
- ‚úÖ **REST API** - —Å—Ç–∞—Ç—É—Å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HTTP
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–æ–Ω—Å–æ–ª—å + —Ñ–∞–π–ª—ã + –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

## üìã –ü—Ä–∞–≤–∏–ª–∞ Anti-Passback

| –°–æ—Å—Ç–æ—è–Ω–∏–µ | –¢–µ—Ä–º–∏–Ω–∞–ª | –î–µ–π—Å—Ç–≤–∏–µ | –î–≤–µ—Ä—å |
|-----------|----------|----------|-------|
| outside | entry (–≤—Ö–æ–¥) | ‚úÖ –†–ê–ó–†–ï–®–ï–ù–û | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è |
| outside | exit (–≤—ã—Ö–æ–¥) | ‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï | –ó–∞–∫—Ä—ã—Ç–∞ |
| inside | entry (–≤—Ö–æ–¥) | ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û | –ó–∞–∫—Ä—ã—Ç–∞ |
| inside | exit (–≤—ã—Ö–æ–¥) | ‚úÖ –†–ê–ó–†–ï–®–ï–ù–û | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è |

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SDK Hikvision
SDK –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. –°–∫–∞—á–∞–π—Ç–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
```bash
# –°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ SDK_INSTALL.md
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -r requirements.txt
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MySQL
```bash
mysql -u root -p < setup_database.sql
```

### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è .env
```bash
cp .env.example .env
nano .env  # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ:**
- `DB_HOST`, `DB_USER`, `DB_PASSWORD` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL
- `TERMINAL_IN_*` –∏ `TERMINAL_OUT_*` - IP –∞–¥—Ä–µ—Å–∞ –≤–∞—à–∏—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
- `TERMINAL_USER`, `TERMINAL_PASSWORD` - —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤

### 5. –ó–∞–ø—É—Å–∫
```bash
python main.py
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ Hikvision

–ù–∞ **–∫–∞–∂–¥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ** (221-230) –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:

1. **Configuration** ‚Üí **Network** ‚Üí **Advanced Settings** ‚Üí **HTTP Listening**
2. –í–∫–ª—é—á–∏—Ç–µ **HTTP Listening**
3. URL: `http://YOUR_SERVER_IP:3000/event`
4. Protocol Version: **1.0**
5. –û—Ç–º–µ—Ç—å—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ **Face Recognition Success**
   - ‚úÖ **Card Swiped**
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üì° API Endpoints

### `GET /`
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
```bash
curl http://localhost:3000/
```

### `GET /status`
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```bash
curl http://localhost:3000/status
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –≤–Ω—É—Ç—Ä–∏ –∑–¥–∞–Ω–∏—è.

### `POST /reset`
–†—É—á–Ω–æ–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π (admin)
```bash
curl -X POST http://localhost:3000/reset
```

### `POST /event`
–ü—Ä–∏–µ–º —Å–æ–±—ã—Ç–∏–π –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã:

**user_states** - —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
SELECT * FROM user_states WHERE state='inside';
```

**event_logs** - –∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
```sql
SELECT * FROM event_logs ORDER BY created_at DESC LIMIT 20;
```

**–ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - —Å–º. —Ñ–∞–π–ª `queries.sql`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
```bash
python check_system.py
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
```bash
python test_system.py
```

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
apb/
‚îú‚îÄ‚îÄ main.py              # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ db.py                # –ú–æ–¥—É–ª—å —Ä–∞–±–æ—Ç—ã —Å MySQL
‚îú‚îÄ‚îÄ requirements.txt     # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–æ–∑–¥–∞—Ç—å!)
‚îú‚îÄ‚îÄ .env.example         # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ setup_database.sql   # –°–æ–∑–¥–∞–Ω–∏–µ –ë–î
‚îú‚îÄ‚îÄ check_system.py      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ test_system.py       # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ HCNetSDK.dll     # SDK Hikvision
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

```env
# –¢–µ—Ä–º–∏–Ω–∞–ª—ã –≤—Ö–æ–¥–∞ (–Ω–µ—á–µ—Ç–Ω—ã–µ IP)
TERMINAL_IN_1=192.168.18.221
TERMINAL_IN_2=192.168.18.223
TERMINAL_IN_3=192.168.18.225
TERMINAL_IN_4=192.168.18.227
TERMINAL_IN_5=192.168.18.229

# –¢–µ—Ä–º–∏–Ω–∞–ª—ã –≤—ã—Ö–æ–¥–∞ (—á–µ—Ç–Ω—ã–µ IP)
TERMINAL_OUT_1=192.168.18.222
TERMINAL_OUT_2=192.168.18.224
TERMINAL_OUT_3=192.168.18.226
TERMINAL_OUT_4=192.168.18.228
TERMINAL_OUT_5=192.168.18.230

# –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
TERMINAL_PORT=8000
TERMINAL_USER=admin
TERMINAL_PASSWORD=123456

# MySQL
DB_HOST=localhost
DB_NAME=apb_system
DB_USER=root
DB_PASSWORD=your_password

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ APB
RESET_TIME=00:00         # –í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ (HH:MM)
DOOR_OPEN_TIME=3         # –°–µ–∫—É–Ω–¥—ã –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–≤–µ—Ä–∏
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
–í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:
```
============================================================
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
üìç –¢–µ—Ä–º–∏–Ω–∞–ª: 192.168.18.221 (entry)
üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: outside
============================================================
‚úÖ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ –≤—Ö–æ–¥–∏—Ç –≤ –∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 192.168.18.221
‚úèÔ∏è  –î–µ–π—Å—Ç–≤–∏–µ: –í–•–û–î –†–ê–ó–†–ï–®–ï–ù
üîÑ –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: inside
============================================================
```

### –õ–æ–≥–∏ —Ñ–∞–π–ª—ã
–î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤ –ø–∞–ø–∫–µ `logs/`:
```
logs/YYYYMMDD_HHMMSS_MMMMMM/
  ‚îú‚îÄ‚îÄ headers.json
  ‚îú‚îÄ‚îÄ AccessControllerEvent.json
  ‚îî‚îÄ‚îÄ photo.jpg
```

### –õ–æ–≥–∏ –≤ MySQL
```sql
-- –°–æ–±—ã—Ç–∏—è —Å–µ–≥–æ–¥–Ω—è
SELECT * FROM event_logs WHERE DATE(created_at) = CURDATE();

-- –ù–∞—Ä—É—à–µ–Ω–∏—è APB
SELECT * FROM event_logs WHERE action_taken LIKE '%–ó–ê–ü–†–ï–©–ï–ù%';

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–Ω—É—Ç—Ä–∏
SELECT * FROM user_states WHERE state='inside';
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `.env` (–Ω–µ –≤ git!)
- ‚úÖ `.gitignore` –∑–∞—â–∏—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
- ‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è

## üö® Troubleshooting

### "Login failed" –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
ping 192.168.18.221

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ .env
```

### "MySQL connection error"
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ MySQL
net start MySQL80          # Windows
systemctl start mysql      # Linux

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å –≤ .env
```

### "HCNetSDK.dll not found"
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ DLL –≤ –ø–∞–ø–∫–µ lib/
ls lib/HCNetSDK.dll
```

### –¢–µ—Ä–º–∏–Ω–∞–ª –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HTTP Listening –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ—Ä—Ç 3000 –¥–æ—Å—Ç—É–ø–µ–Ω

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Python 3.8+**
- **Flask 3.0** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **MySQL 8.0+** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **mysql-connector-python** - –¥—Ä–∞–π–≤–µ—Ä –ë–î
- **HCNetSDK.dll** - SDK Hikvision

## üìù –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8 –∏–ª–∏ –≤—ã—à–µ
- MySQL 8.0 –∏–ª–∏ –≤—ã—à–µ
- Windows 10/11 –∏–ª–∏ Linux
- HCNetSDK.dll –æ—Ç Hikvision
- –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫

### Windows (Task Scheduler)
–°–æ–∑–¥–∞–π—Ç–µ bat —Ñ–∞–π–ª –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á.

### Linux (systemd)
```bash
sudo nano /etc/systemd/system/apb.service
```
–°–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `python check_system.py`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `logs/` –∏ —Ç–∞–±–ª–∏—Ü—É `event_logs`
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

akmalovichdev - –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã ¬© 2024

---

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞:** –û–∫—Ç—è–±—Ä—å 2024
